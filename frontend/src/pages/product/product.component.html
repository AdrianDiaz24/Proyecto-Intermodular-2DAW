<section class="p-product">
  <!-- Contenido principal -->
  <main class="p-product__main">
    <!-- Breadcrumb -->
    <nav class="p-product__breadcrumb">
      <a href="/" class="p-product__breadcrumb-link">Inicio</a>
      <span class="p-product__breadcrumb-separator">/</span>
      <a href="/buscar" class="p-product__breadcrumb-link">Productos</a>
      <span class="p-product__breadcrumb-separator">/</span>
      <span class="p-product__breadcrumb-current">{{ product.name }}</span>
    </nav>

    <!-- Recuadro único con toda la información -->
    <article class="p-product__card">
      <div class="p-product__card-grid">
        <!-- Imagen principal con responsive y lazy loading -->
        <div class="p-product__image-container">
          <picture>
            <source
                [srcset]="product.image"
                type="image/avif">
            <img
                [src]="product.image"
                [alt]="product.name"
                class="p-product__image"
                loading="lazy"
                decoding="async"
                width="400"
                height="400">
          </picture>
        </div>

        <!-- Información del producto -->
        <section class="p-product__info">
          <h1 class="p-product__title">{{ product.name }}</h1>
          <p class="p-product__brand">Marca: <strong>{{ product.brand }}</strong></p>
          <p class="p-product__model">Modelo: <strong>{{ product.model }}</strong></p>

          <!-- Especificaciones -->
          <section>
            <h3 class="p-product__spec-title">Especificaciones</h3>
            <dl class="p-product__spec-list">
              <div class="p-product__spec-item">
                <dt class="p-product__spec-label">Peso:</dt>
                <dd class="p-product__spec-value">{{ product.specifications.weight }}</dd>
              </div>
              <div class="p-product__spec-item">
                <dt class="p-product__spec-label">Ancho:</dt>
                <dd class="p-product__spec-value">{{ product.specifications.width }}</dd>
              </div>
              <div class="p-product__spec-item">
                <dt class="p-product__spec-label">Largo:</dt>
                <dd class="p-product__spec-value">{{ product.specifications.length }}</dd>
              </div>
              <div class="p-product__spec-item">
                <dt class="p-product__spec-label">Alto:</dt>
                <dd class="p-product__spec-value">{{ product.specifications.height }}</dd>
              </div>
              <div class="p-product__spec-item">
                <dt class="p-product__spec-label">Consumo Eléctrico:</dt>
                <dd class="p-product__spec-value">{{ product.specifications.consumption }}</dd>
              </div>
              <div class="p-product__spec-item">
                <dt class="p-product__spec-label">Características:</dt>
                <dd class="p-product__spec-value">{{ product.specifications.characteristics }}</dd>
              </div>
            </dl>
          </section>
        </section>
      </div>

      <!-- Tarjeta de estadísticas de incidencias -->
      <section class="p-product__stats">
        <article class="p-product__stat-item">
          <span class="p-product__stat-label">Incidencias Reportadas</span>
          <span class="p-product__stat-value">{{ product.incidences }}</span>
        </article>
        <article class="p-product__stat-item">
          <span class="p-product__stat-label">Resueltas</span>
          <span class="p-product__stat-value">{{ product.solved }}</span>
        </article>
        <article class="p-product__stat-item">
          <span class="p-product__stat-label">Tasa de resolución</span>
          <span class="p-product__stat-value">{{ (product.solved / product.incidences * 100 | number: '1.0-0') }}%</span>
        </article>
      </section>
    </article>

    <!-- Carrusel de incidencias -->
    <section class="p-product__incidences-section" *ngIf="incidences.length > 0">
      <div class="p-product__incidences-header">
        <h2 class="p-product__incidences-title">Incidencias Reportadas</h2>
        <app-add-button
          title="Reportar nueva incidencia"
          (click)="onAddIncidence()"
        ></app-add-button>
      </div>

      <div class="p-product__carousel">
        <!-- Botón anterior -->
        <button
          class="p-product__carousel-btn p-product__carousel-btn--prev"
          (click)="prevSlide()"
          [disabled]="currentSlide === 0"
          aria-label="Incidencias anteriores"
        >
          ‹
        </button>

        <!-- Contenedor de tarjetas -->
        <div class="p-product__carousel-container">
          <div class="p-product__carousel-track" [style.transform]="'translateX(' + (-currentSlide * 33.333) + '%)'">
            <article class="p-product__incidence-card" *ngFor="let incidence of incidences" (click)="viewIncidence(incidence.id)">
              <div class="p-product__incidence-header">
                <div class="p-product__incidence-content">
                  <h3 class="p-product__incidence-title">{{ incidence.title }}</h3>
                  <span class="p-product__incidence-status" [ngClass]="{ 'solved': incidence.solved }">
                    {{ incidence.solved ? 'Resuelta' : 'Pendiente' }}
                  </span>
                  <p class="p-product__incidence-user">{{ incidence.user }}</p>
                  <p class="p-product__incidence-date">{{ incidence.date }}</p>
                </div>
              </div>
              <div class="p-product__incidence-footer">
                <span class="p-product__incidence-replies">{{ incidence.replies }} respuestas</span>
              </div>
            </article>
          </div>
        </div>

        <!-- Botón siguiente -->
        <button
          class="p-product__carousel-btn p-product__carousel-btn--next"
          (click)="nextSlide()"
          [disabled]="currentSlide >= incidences.length - itemsPerView"
          aria-label="Más incidencias"
        >
          ›
        </button>
      </div>
    </section>

    <!-- Buscador y filtro de incidencias -->
    <section class="p-product__search-section">
      <div class="p-product__search-container">
        <input
          type="text"
          class="p-product__search-input"
          placeholder="Buscar incidencias..."
          [(ngModel)]="searchQuery"
          (keyup)="onSearch()"
        >
        <button class="p-product__search-btn" (click)="onSearch()">
          <img src="/assets/icons/buscar.avif" alt="Buscar">
        </button>
      </div>

      <div class="p-product__filter-container">
        <label class="p-product__filter-label">Filtrar:</label>
        <select
          class="p-product__filter-select"
          [(ngModel)]="filterStatus"
          (change)="onStatusFilterChange()"
        >
          <option value="all">Sin filtro</option>
          <option value="pending">Pendientes</option>
          <option value="solved">Resueltas</option>
        </select>
      </div>
    </section>

    <!-- Resultados de búsqueda -->
    <section class="p-product__search-results" *ngIf="filteredIncidences.length > 0 && (searchQuery || filterStatus !== 'all')">
      <div class="p-product__results-grid">
        <article class="p-product__result-card" *ngFor="let incidence of filteredIncidences" (click)="viewIncidence(incidence.id)">
          <div class="p-product__result-header">
            <h3 class="p-product__result-title">{{ incidence.title }}</h3>
            <span class="p-product__result-status" [ngClass]="{ 'solved': incidence.solved }">
              {{ incidence.solved ? 'Resuelta' : 'Pendiente' }}
            </span>
          </div>
          <p class="p-product__result-user">{{ incidence.user }}</p>
          <p class="p-product__result-date">{{ incidence.date }}</p>
          <div class="p-product__result-footer">
            <span class="p-product__result-replies">{{ incidence.replies }} respuestas</span>
          </div>
        </article>
      </div>
    </section>

    <!-- Sin resultados -->
    <section class="p-product__no-results" *ngIf="filteredIncidences.length === 0 && (searchQuery || filterStatus !== 'all')">
      <p>No se encontraron incidencias que coincidan con tu búsqueda</p>
    </section>
  </main>
</section>

<!-- Modal para reportar incidencia -->
<app-report-incidence
  *ngIf="showReportIncidenceModal"
  [productName]="product.name"
  (close)="onCloseReportModal()"
  (formSubmit)="onReportIncidenceSubmit($event)"
></app-report-incidence>
